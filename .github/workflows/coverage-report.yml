name: Coverage Report

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  coverage:
    name: ğŸ“Š Generate Coverage Report
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: ğŸ”§ Install dependencies
      run: |
        poetry install --with dev

    - name: ğŸ“Š Generate coverage report
      run: |
        echo "Running tests with coverage..."
        poetry run coverage run -m pytest --ignore=tests/test_for_qemu.py
        
        echo "Generating HTML coverage report..."
        poetry run coverage html --directory=coverage-html
        
        echo "Coverage summary:"
        poetry run coverage report

    - name: ğŸ“„ Setup Pages
      uses: actions/configure-pages@v5

    - name: ğŸ“¤ Upload coverage artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './coverage-html'

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4